/**
 * @fileoverview Firestore Security Rules for the Agenda Alego app.
 *
 * Core Philosophy:
 * This ruleset implements a public-read, admin-write model for event data, with administrative privileges managed through a dedicated 'roles_admin' collection.
 *
 * Data Structure:
 * - /events/{eventId}: Stores event details (name, date, location, etc.). Anyone can read events. Only admins can create, update, or delete events.
 * - /roles_admin/{userId}: Presence of a document indicates admin status. Document content is irrelevant.
 *
 * Key Security Decisions:
 * - Public Read Access: The /events collection is publicly readable to support the app's core functionality of displaying events.
 * - Admin-Only Write Access: Write operations on /events are restricted to users with admin privileges, as determined by the presence of a document in /roles_admin/{userId}.
 * - Existence-Based Roles: Admin privileges are granted based on the *existence* of a document in the `roles_admin` collection, not its content.
 * - No User Listing: Listing of users is not permitted.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read events. Only admins can create, update, or delete events.
     * @path /events/{eventId}
     * @allow (get, list): Any authenticated user can read event data.
     * @allow (create, update, delete): Only a user with a document in /roles_admin/{userId} can modify event data.
     * @deny (create, update, delete): Non-admin users cannot modify event data.
     * @principle Public read, admin-only write access is enforced for event data.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants administrative privileges based on the existence of a document for the user ID in this collection.
     * @path /roles_admin/{userId}
     * @allow (create): A user can create their own admin document. This may need further restriction in a production environment.
     * @allow (get): Only the user themselves can check if they have admin privileges.
     * @allow (list): No listing of admin documents is allowed.
     * @deny (update, delete): Only the system should be able to update or delete admin documents, after creation.
     * @principle: Existence of a document in this collection grants admin privileges.
     */
    match /roles_admin/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}