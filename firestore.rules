rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to read any document.
     * @path /{document=**}
     * @allow (get, list) Any authenticated user can read any document.
     * @deny (get, list) N/A
     * @principle Public read access for all authenticated users.
     */
    match /{document=**} {
      allow get, list: if isSignedIn();
    }

    /**
     * @description Manages read and write access to the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (create, update, delete) An authenticated user who is also an admin can perform write operations.
     * @allow (get, list) Any authenticated user can read event details.
     * @deny (create, update, delete) A non-admin user cannot perform write operations.
     * @deny (create, update, delete) An unauthenticated user cannot perform write operations.
     * @principle Enforces role-based access control for event management.
     */
    match /events/{eventId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages read and write access to the /transmission_operators/{operatorId} collection.
     * @path /transmission_operators/{operatorId}
     * @allow (create, update, delete) An authenticated user can perform write operations.
     * @allow (get, list) Any authenticated user can read data.
     * @deny (create, update, delete) An unauthenticated user cannot perform write operations.
     * @principle Authenticated users only can write operations.
     */
    match /transmission_operators/{operatorId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages read and write access to the /cinematographic_reporters/{reporterId} collection.
     * @path /cinematographic_reporters/{reporterId}
     * @allow (create, update, delete) An authenticated user can perform write operations.
     * @allow (get, list) Any authenticated user can read data.
     * @deny (create, update, delete) An unauthenticated user cannot perform write operations.
     * @principle Authenticated users only can write operations.
     */
    match /cinematographic_reporters/{reporterId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages read and write access to the /production_personnel/{personnelId} collection.
     * @path /production_personnel/{personnelId}
     * @allow (create, update, delete) An authenticated user can perform write operations.
     * @allow (get, list) Any authenticated user can read data.
     * @deny (create, update, delete) An unauthenticated user cannot perform write operations.
     * @principle Authenticated users only can write operations.
     */
    match /production_personnel/{personnelId} {
        allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Restricts all client-side write access to the /audit_logs/{logId} collection.
     * @path /audit_logs/{logId}
     * @allow (write) No client-side writes are allowed. All writes must originate from trusted server-side logic.
     * @deny (create, update, delete) All client-side write requests are denied.
     * @principle Ensures audit logs can only be written by the system.
     */
    match /audit_logs/{logId} {
        allow create, update, delete: if false;
        allow get, list: if false;
    }

    /**
     * @description Grants administrative privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow (create) Allows creating an admin user if the authenticated user ID matches the document ID.
     * @deny (create) Denies creating an admin user if the authenticated user ID does not match the document ID.
     * @principle Existence over content: the presence of a document grants admin access.
     */
    match /roles_admin/{userId} {
        allow get, list: if isAdmin();
        allow create: if isOwner(userId);
        allow update, delete: if false;
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is an admin by verifying the existence of a document in the roles_admin collection.
   * @return {boolean} True if the user is an admin, false otherwise.
   */
  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
}