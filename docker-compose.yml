version: '3.8'
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3050:3050"
    environment:
      - NODE_ENV=production
      # Usa o nome do serviço 'ollama' como host, que o Docker resolve automaticamente
      - OLLAMA_HOST=http://ollama:11434
      # Passa as credenciais necessárias para o container
      - FIREBASE_CREDENTIALS=${FIREBASE_CREDENTIALS}
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_auth_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
    networks:
      - agenda-alego-net
    # Removido o 'command' para usar o CMD do Dockerfile (node server.js)
    depends_on:
      - ollama

  ollama:
    image: ollama/ollama:latest
    container_name: agenda-alego-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - agenda-alego-net

volumes:
  ollama-data: {}

networks:
  agenda-alego-net:
    driver: bridge