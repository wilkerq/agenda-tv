rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======================================================
    // üîπ Fun√ß√µes auxiliares de seguran√ßa
    // ======================================================

    // Verifica se o usu√°rio est√° autenticado na requisi√ß√£o.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usu√°rio autenticado possui a fun√ß√£o de administrador.
    function isAdmin() {
      // Um usu√°rio s√≥ pode ser admin se estiver autenticado e seu UID
      // existir na cole√ß√£o de controle de administradores.
      return isAuthenticated() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }


    // ======================================================
    // üîπ Regras para cole√ß√µes administrativas
    // ======================================================

    // Cole√ß√£o de logs de auditoria: muito restrita para garantir integridade.
    match /audit_logs/{logId} {
      // Ningu√©m pode ler, alterar ou apagar logs existentes.
      allow read, update, delete: if false;
      // Apenas administradores autenticados podem criar novos registros de log.
      allow create: if isAdmin();
    }

    // Cole√ß√£o que define quem s√£o os administradores.
    match /roles_admin/{userId} {
      // Apenas outros administradores podem ver a lista de admins ou adicionar novos.
      allow read, create: if isAdmin();
      // Ningu√©m pode modificar ou remover um administrador para evitar escalada de privil√©gios.
      allow update, delete: if false;
    }


    // ======================================================
    // üîπ Regras para cole√ß√µes com acesso p√∫blico
    // ======================================================

    // A cole√ß√£o 'events' √© a √∫nica que pode ser lida por qualquer pessoa.
    match /events/{eventId} {
      // Leitura p√∫blica permitida para o calend√°rio de eventos.
      allow get, list: if true;
      // Apenas administradores podem criar, editar ou apagar eventos.
      allow create, update, delete: if isAdmin();
    }


    // ======================================================
    // üîπ Regra padr√£o para todas as outras cole√ß√µes (privadas por padr√£o)
    // ======================================================
    // Esta regra se aplica a todas as cole√ß√µes que n√£o foram definidas acima,
    // como 'transmission_operators', 'production_personnel', etc.
    match /{collection}/{docId} {
      // Apenas administradores podem ler ou escrever em qualquer outra cole√ß√£o.
      // Isso protege dados sens√≠veis (como nomes e telefones de pessoal) por padr√£o.
      allow read, write: if isAdmin();
    }
  }
}
